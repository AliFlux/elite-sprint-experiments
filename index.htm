<!DOCTYPE html>
<html>
<body>
  <h3>WebRTC Video + KLV Streaming</h3>
  <video id="video" autoplay playsinline controls width="1000" height="600"></video>
  <script>
    async function start() {
      const videoEl = document.getElementById("video");

      // 1) Request server offer (server will create the offer)
      const offerResp = await fetch("/offer", { method: "POST" });
      const offer = await offerResp.json();

      // 2) Create PeerConnection on client and set track handler
      const pc = new RTCPeerConnection();
      pc.ontrack = (e) => {
        videoEl.srcObject = e.streams[0];
      };

      // Simple handler to log incoming data channel messages
      pc.ondatachannel = (ev) => {
        const ch = ev.channel;
        ch.onmessage = (m) => {
          console.log("Received KLV/data:", m.data);
        };
      };

      // 3) Set remote description (server offer)
      await pc.setRemoteDescription(offer);

      // 4) create answer and setLocalDescription
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // 5) send answer back to server
      await fetch("/answer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pc.localDescription)
      });
    }

    start();
  </script>
</body>
</html>
