<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GStreamer + KLV WebRTC Client</title>
</head>
<body>
    <h1>WebRTC Video Stream</h1>
    <video id="video" autoplay playsinline controls style="width: 80%; border: 1px solid black;"></video>
    <script>
        const signalingUrl = "ws://127.0.0.1:8765";
        const pc = new RTCPeerConnection();

        // Video element
        const videoEl = document.getElementById("video");
        pc.ontrack = (event) => {
            console.log("Received track:", event.track.kind);
            videoEl.srcObject = event.streams[0];
        };

        // DataChannel for KLV metadata
        let klvDataChannel;
        pc.ondatachannel = (event) => {
            console.log("DataChannel created:", event.channel.label);
            klvDataChannel = event.channel;

            klvDataChannel.onopen = () => {
                console.log("KLV DataChannel open");
            };

            klvDataChannel.onmessage = (msgEvent) => {
                try {
                    const metadata = JSON.parse(msgEvent.data);
                    console.log("KLV metadata:", metadata);
                } catch (err) {
                    console.log("Received raw KLV data:", msgEvent.data);
                }
            };
        };

        async function start() {
            const ws = new WebSocket(signalingUrl);

            ws.onopen = async () => {
                console.log("Connected to signaling server");

                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Send offer to Python server
                ws.send(JSON.stringify(pc.localDescription));
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === "answer") {
                    console.log("Received answer from server");
                    await pc.setRemoteDescription(msg);
                }
            };

            ws.onclose = () => {
                console.log("Signaling server closed");
            };

            ws.onerror = (err) => {
                console.error("Signaling error:", err);
            };
        }

        start();
    </script>
</body>
</html>
